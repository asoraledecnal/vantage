<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Account - Vantage</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
</head>
<body class="auth-body">

    <div class="auth-texture auth-texture--radial" aria-hidden="true"></div>

    <main class="auth-shell">
        <section class="auth-hero">
            <p class="auth-eyebrow">Final Step</p>
            <h1>Verify your identity.</h1>
            <p class="auth-lede">
                An OTP has been sent to your email. Check your inbox and enter the code to complete your registration and secure your account.
            </p>
            <ul class="auth-highlights">
                <li>Secure your new credentials</li>
                <li>Unlock your personalized dashboard</li>
                <li>Complete the onboarding sequence</li>
            </ul>
        </section>

        <section class="auth-panel">
            <form id="otp-form" class="auth-form">
                <div class="form-header">
                    <h2>Enter Your OTP</h2>
                    <p>An OTP was sent to <strong id="user-email-display"></strong>. Please enter the 6-digit code below.</p>
                </div>
                <div class="form-group">
                    <label for="otp">One-Time Password</label>
                    <input type="text" id="otp" name="otp" placeholder="123456" required pattern="\d{6}" title="Please enter a 6-digit OTP" autocomplete="one-time-code">
                </div>
                <button type="submit" class="btn-primary">Verify Account</button>
                <div id="message"></div>
                <p class="signup-link">Didn't get an email? <a href="signup.html">Try signing up again</a></p>
                <a href="index.html" class="back-btn">← Back to Home</a>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const otpForm = document.getElementById('otp-form');
            const messageDiv = document.getElementById('message');
            const emailDisplay = document.getElementById('user-email-display');
            const submitButton = otpForm.querySelector('button[type="submit"]');
            const signupLink = document.querySelector('.signup-link');

            // Get email and source from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const source = urlParams.get('source');

            if (email) {
                emailDisplay.textContent = decodeURIComponent(email);
            } else {
                // Handle case where email is missing
                emailDisplay.textContent = "your email";
                const formHeader = document.querySelector('.form-header');
                formHeader.innerHTML += '<p class="message error">Could not find email from URL. Please try again.</p>';
            }

            if (source === 'reset') {
                submitButton.textContent = 'Verify OTP';
                signupLink.innerHTML = 'Didn\'t get an email? <a href="forgot_password.html">Try again</a>';
            }
            
            // --- Configuration for Backend URL ---
            const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            const BACKEND_URL = isLocal ? "http://127.0.0.1:5000" : "https://vantage-backend-api.onrender.com";

            if (otpForm) {
                otpForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const otp = document.getElementById('otp').value;
                    
                    // Ensure email was found from URL before submitting
                    if (!email) {
                        messageDiv.textContent = 'Email is missing from URL. Please try again.';
                        messageDiv.className = 'message error';
                        messageDiv.style.display = 'block';
                        return;
                    }

                    messageDiv.textContent = '';
                    messageDiv.style.display = 'none';

                    try {
                        const response = await fetch(`${BACKEND_URL}/api/verify-otp`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email, otp }) // Use email from URL
                        });

                        const data = await response.json();

                        messageDiv.textContent = data.message;
                        messageDiv.style.display = 'block';

                        if (response.ok) {
                            messageDiv.className = 'message success';
                            if (source === 'reset') {
                                // Redirect to reset password page on success
                                messageDiv.textContent = 'OTP verified. Redirecting to reset password…';
                                setTimeout(() => {
                                    window.location.href = `reset_password.html?email=${encodeURIComponent(email)}&otp=${encodeURIComponent(otp)}`;
                                }, 2000);
                            } else {
                                // Redirect to login page on success
                                messageDiv.textContent = 'Account verified. Redirecting to login…';
                                setTimeout(() => {
                                    window.location.href = 'login.html';
                                }, 2000);
                            }
                        } else {
                            messageDiv.className = 'message error';
                        }
                    } catch (error) {
                        console.error("OTP verification error:", error);
                        messageDiv.textContent = 'A network error occurred. Please try again.';
                        messageDiv.className = 'message error';
                        messageDiv.style.display = 'block';
                    }
                });
            }
        });
    </script>
</body>
</html>