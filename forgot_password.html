<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Vantage</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
</head>
<body class="auth-body">

    <div class="auth-texture auth-texture--radial" aria-hidden="true"></div>

    <main class="auth-shell">
        <section class="auth-hero">
            <p class="auth-eyebrow">Account Recovery</p>
            <h1>Reset your password.</h1>
            <p class="auth-lede">
                Enter your email address below. If an account exists, we will send a One-Time Password (OTP) to your inbox to begin the reset process.
            </p>
            <ul class="auth-highlights">
                <li>Receive a secure, single-use OTP</li>
                <li>Verify your identity safely</li>
                <li>Regain access to your account</li>
            </ul>
        </section>

        <section class="auth-panel">
            <form id="forgot-password-form" class="auth-form">
                <div class="form-header">
                    <h2>Forgot Password</h2>
                    <p>Enter your account's email address.</p>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="cedriclaja@gmail.com" required>
                </div>
                <button type="button" id="forgot-password-submit" class="btn-primary">Send Reset OTP</button>
                <div id="message"></div>
                <p class="signup-link">Remember your password? <a href="login.html">Sign in</a></p>
                <a href="index.html" class="back-btn">← Back to Home</a>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const submitButton = document.getElementById('forgot-password-submit');
            const emailInput = document.getElementById('email');
            const messageDiv = document.getElementById('message');
            const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            const BACKEND_URL = isLocal ? "http://127.0.0.1:5000" : "https://vantage-backend-api.onrender.com";

            if (!forgotPasswordForm || !messageDiv || !emailInput) {
                return;
            }

            let isSubmitting = false;

            const showMessage = (text, status) => {
                messageDiv.textContent = text;
                messageDiv.className = `message ${status}`;
                messageDiv.style.display = 'block';
            };

            const hideMessage = () => {
                messageDiv.textContent = '';
                messageDiv.style.display = 'none';
                messageDiv.className = '';
            };

            const redirectToOtpPage = (email) => {
                showMessage('OTP sent. Redirecting to verification…', 'success');
                setTimeout(() => {
                    window.location.href = `verify_otp.html?email=${encodeURIComponent(email)}&source=reset`;
                }, 2000);
            };

            const handleSubmit = async (event) => {
                if (event) {
                    event.preventDefault();
                }
                if (isSubmitting) {
                    return;
                }

                const email = emailInput.value.trim();
                if (!email) {
                    showMessage('Please enter an email address.', 'error');
                    return;
                }

                hideMessage();
                isSubmitting = true;
                if (submitButton) {
                    submitButton.disabled = true;
                }

                try {
                    const response = await fetch(`${BACKEND_URL}/api/forgot-password`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        redirectToOtpPage(email);
                    } else {
                        showMessage(data.message || 'Unable to send OTP. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error("Forgot password error:", error);
                    showMessage('A network error occurred. Please try again.', 'error');
                } finally {
                    isSubmitting = false;
                    if (submitButton) {
                        submitButton.disabled = false;
                    }
                }
            };

            forgotPasswordForm.addEventListener('submit', handleSubmit);
            if (submitButton) {
                submitButton.addEventListener('click', handleSubmit);
            }
        });
    </script>
</body>
</html>
